name: build

on:
  push:
    branches: ["**"]
    tags: ["v*"]
  pull_request:
  workflow_dispatch:

permissions:
  contents: write

env:
  # This gives a stable label for artifacts:
  # - tag builds use the tag name (v0.2.0)
  # - other builds use sha-<7 chars>
  ARTIFACT_TAG: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || format('sha-{0}', github.sha) }}

jobs:
  linux-amd64:
    name: linux (amd64)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            meson ninja-build pkg-config \
            libgtkmm-3.0-dev libfontconfig1-dev \
            curl unzip python3

      - name: Fetch Font Awesome (Free)
        run: |
          chmod +x scripts/fetch-fontawesome.sh
          ./scripts/fetch-fontawesome.sh

      - name: Build (release)
        run: |
          meson setup build --buildtype=release
          meson compile -C build

      - name: Package
        run: |
          set -euo pipefail
          rm -rf dist
          mkdir -p dist/share/sv-dashboard-gtk/fonts
          cp -f build/sv-dashboard dist/
          cp -f assets/fonts/*.ttf dist/share/sv-dashboard-gtk/fonts/
          tar -czf sv-dashboard-${{ env.ARTIFACT_TAG }}-linux-amd64.tar.gz -C dist .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-amd64
          path: sv-dashboard-${{ env.ARTIFACT_TAG }}-linux-amd64.tar.gz

  linux-arm64:
    name: linux (arm64)
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            meson ninja-build pkg-config \
            libgtkmm-3.0-dev libfontconfig1-dev \
            curl unzip python3

      - name: Fetch Font Awesome (Free)
        run: |
          chmod +x scripts/fetch-fontawesome.sh
          ./scripts/fetch-fontawesome.sh

      - name: Build (release)
        run: |
          meson setup build --buildtype=release
          meson compile -C build

      - name: Package
        run: |
          set -euo pipefail
          rm -rf dist
          mkdir -p dist/share/sv-dashboard-gtk/fonts
          cp -f build/sv-dashboard dist/
          cp -f assets/fonts/*.ttf dist/share/sv-dashboard-gtk/fonts/
          tar -czf sv-dashboard-${{ env.ARTIFACT_TAG }}-linux-arm64.tar.gz -C dist .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-arm64
          path: sv-dashboard-${{ env.ARTIFACT_TAG }}-linux-arm64.tar.gz

  windows-x64:
    name: windows (x64)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up MSYS2 (MINGW64)
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-pkgconf
            mingw-w64-x86_64-gtkmm3
            mingw-w64-x86_64-meson
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-fontconfig
            mingw-w64-x86_64-curl
            mingw-w64-x86_64-python
            unzip
            p7zip
            git

      - name: Fetch Font Awesome (Free)
        shell: msys2 {0}
        run: |
          chmod +x scripts/fetch-fontawesome.sh
          ./scripts/fetch-fontawesome.sh

      - name: Configure (release)
        shell: msys2 {0}
        run: |
          meson setup build --buildtype=release

      - name: Build
        shell: msys2 {0}
        run: |
          meson compile -C build

      - name: Package portable zip (includes run.bat)
        shell: msys2 {0}
        run: |
          # Package portable zip (includes run.bat)
          set -euo pipefail
          rm -rf dist sv-dashboard-windows-x64.zip
          mkdir -p dist/share dist/lib dist/etc dist/var/cache dist/home
          
          cp -f build/sv-dashboard.exe dist/sv-dashboard.exe
          
          mkdir -p dist/share/sv-dashboard-gtk/fonts
          cp -f assets/fonts/*.ttf dist/share/sv-dashboard-gtk/fonts/
          
          # Ship gdbus.exe so GIO does not pick up Cygwin's gdbus.exe
          cp -f /mingw64/bin/gdbus.exe dist/ || true
          
          # Copy dependent DLLs (app + gdbus)
          copy_deps () {
          local bin="$1"
          if [ -f "$bin" ]; then
          for d in $(ldd "$bin" | awk '{print $3}' | grep -E "^/mingw64/bin/.*\.dll$" | sort -u); do
          cp -f "$d" dist/
          done
          fi
        }
          copy_deps build/sv-dashboard.exe
          copy_deps /mingw64/bin/gdbus.exe
          
          # GLib spawn helpers (recommended on Windows)
          cp -f /mingw64/bin/gspawn-win64-helper.exe dist/ || true
          cp -f /mingw64/bin/gspawn-win64-helper-console.exe dist/ || true
          
          # GLib schemas (GSettings)
          mkdir -p dist/share/glib-2.0/schemas
          cp -r /mingw64/share/glib-2.0/schemas/* dist/share/glib-2.0/schemas/
          /mingw64/bin/glib-compile-schemas dist/share/glib-2.0/schemas
          
          # gdk-pixbuf loaders + cache
          mkdir -p dist/lib/gdk-pixbuf-2.0/2.10.0/loaders
          cp -r /mingw64/lib/gdk-pixbuf-2.0/2.10.0/loaders/* dist/lib/gdk-pixbuf-2.0/2.10.0/loaders/
          /mingw64/bin/gdk-pixbuf-query-loaders > dist/lib/gdk-pixbuf-2.0/2.10.0/loaders.cache
          
          # Fontconfig config (required for portable fontconfig usage)
          cp -r /mingw64/etc/fonts dist/etc/
          
          # Create run.bat (adds HOME + XDG_CACHE_HOME to fix cache errors)
          cat > dist/run.bat <<'EOF'
          @echo off
          setlocal
          set "DIR=%~dp0"
          
          rem Keep PATH clean so we don't accidentally pick up Cygwin/Git-bash tools.
          set "PATH=%DIR%;%SystemRoot%\System32;%SystemRoot%"
          
          rem --- Make fontconfig happy (writable cache) ---
          set "HOME=%DIR%home"
          set "XDG_CACHE_HOME=%DIR%var\cache"
          
          rem --- App/bundle paths ---
          set "SV_DASHBOARD_FONT_DIR=%DIR%share\sv-dashboard-gtk\fonts"
          set "FONTCONFIG_FILE=%DIR%etc\fonts\fonts.conf"
          set "FONTCONFIG_PATH=%DIR%etc\fonts"
          set "GSETTINGS_SCHEMA_DIR=%DIR%share\glib-2.0\schemas"
          set "GDK_PIXBUF_MODULE_FILE=%DIR%lib\gdk-pixbuf-2.0\2.10.0\loaders.cache"
          set "GDK_PIXBUF_MODULEDIR=%DIR%lib\gdk-pixbuf-2.0\2.10.0\loaders"
          
          "%DIR%sv-dashboard.exe"
          endlocal
          EOF
          
          7z a sv-dashboard-${{ env.ARTIFACT_TAG }}-windows-x64.zip ./dist/*

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64
          path: sv-dashboard-${{ env.ARTIFACT_TAG }}-windows-x64.zip

  publish:
    name: publish to GitHub Release
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [linux-amd64, linux-arm64, windows-x64]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets

      - name: Publish
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release-assets/linux-amd64/*.tar.gz
            release-assets/linux-arm64/*.tar.gz
            release-assets/windows-x64/*.zip
